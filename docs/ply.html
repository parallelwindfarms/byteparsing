<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced example: parsing PLY files &mdash; byteparsing 0.1.2 documentation</title>
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Architecture" href="architecture.html" />
    <link rel="prev" title="Parsing PPM files" href="ppm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> byteparsing
          </a>
              <div class="version">
                0.1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cursors.html">Cursors</a></li>
<li class="toctree-l1"><a class="reference internal" href="parsers.html">Parsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="functional.html">Introduction to Functional Parsing in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples of usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="ppm.html">Parsing PPM files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced example: parsing PLY files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Header">Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-Stanford-Bunny">The Stanford Bunny</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">byteparsing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Advanced example: parsing PLY files</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/ply.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Advanced-example:-parsing-PLY-files">
<h1>Advanced example: parsing PLY files<a class="headerlink" href="#Advanced-example:-parsing-PLY-files" title="Permalink to this heading"></a></h1>
<p>PLY is a file format storing 3D polygonal data that has support for both ASCII and binary formats. Some references: <a class="reference external" href="https://en.wikipedia.org/wiki/PLY_(file_format)">Wikipedia entry</a> and <a class="reference external" href="http://paulbourke.net/dataformats/ply/">Paul Bourke’s pages</a>. The specification of the PLY format is a bit vague and allows for liberal interpretation and custom user defined fields. We take a look at the example on Paul Bourke’s page:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ply
format ascii 1.0           { ascii/binary, format version number }
comment made by Greg Turk  { comments keyword specified, like all lines }
comment this file is a cube
element vertex 8           { define &quot;vertex&quot; element, 8 of them in file }
property float x           { vertex contains float &quot;x&quot; coordinate }
property float y           { y coordinate is also a vertex property }
property float z           { z coordinate, too }
element face 6             { there are 6 &quot;face&quot; elements in the file }
property list uchar int vertex_index { &quot;vertex_indices&quot; is a list of ints }
end_header                 { delimits the end of the header }
0 0 0                      { start of vertex list }
0 0 1
0 1 1
0 1 0
1 0 0
1 0 1
1 1 1
1 1 0
4 0 1 2 3                  { start of face list }
4 7 6 5 4
4 0 4 5 1
4 1 5 6 2
4 2 6 7 3
4 3 7 4 0
</pre></div>
</div>
<p>We see a header that is always ASCII encoded. The header specifies a list of <em>elements</em>, each containing a list of <em>properties</em>. The listed elements determine how to parse the data section of the PLY file. The data section maybe encoded in ASCII or binary.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from __future__ import annotations
from typing import Optional
from dataclasses import dataclass
from functools import partial
import numpy as np
import pprint

from byteparsing import (parse_bytes, Parser, parser)
from byteparsing.parsers import (
    sequence, named_sequence, choice, optional, value, repeat_n,
    text_literal, char, text_one_of, text_end_by,
    byte_none_of, byte_one_of,
    flush, flush_decode,
    push, pop, char_pred,
    many, some, many_char, some_char, many_char_0, some_char_0,
    integer, scientific_number, array, binary_value,
    fmap, construct)

pp = pprint.PrettyPrinter(indent=2, width=80)
</pre></div>
</div>
</div>
<section id="Header">
<h2>Header<a class="headerlink" href="#Header" title="Permalink to this heading"></a></h2>
<p>The header starts with a “magic number”, a line containing <code class="docutils literal notranslate"><span class="pre">ply</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>eol = choice(text_literal(&quot;\n&quot;), text_literal(&quot;\n\r&quot;))
ply_magic_number = sequence(text_literal(&quot;ply&quot;), eol)
</pre></div>
</div>
</div>
<p>The second line indicates which variation of the PLY format this is. We will store header information in data classes and enums.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from enum import Enum

class PlyFormat(Enum):
    ASCII = 1
    BINARY_LE = 2
    BINARY_BE = 3

    @staticmethod
    def from_string(format_str: str) -&gt; PlyFormat:
        if format_str == &quot;ascii&quot;:
            return PlyFormat.ASCII
        if format_str == &quot;binary_little_endian&quot;:
            return PlyFormat.BINARY_LE
        if format_str == &quot;binary_big_endian&quot;:
            return PlyFormat.BINARY_BE
        else:
            raise ValueError(f&quot;Unrecognized format string: {s}&quot;)
</pre></div>
</div>
</div>
<p>Since each item in the header is seperated by a newline, we need a <code class="docutils literal notranslate"><span class="pre">tokenize</span></code> function that doesn’t skip newlines. From that we can define what we may consider to be a <code class="docutils literal notranslate"><span class="pre">word</span></code> in a PLY header. We <code class="docutils literal notranslate"><span class="pre">flush</span></code> the cursor, expect a <code class="docutils literal notranslate"><span class="pre">ascii_alpha</span></code> character (words don’t start with numbers) and then many characters that are letters, numbers or underscores. At the end we <code class="docutils literal notranslate"><span class="pre">flush</span></code> the cursor again, decoding to a Python string. We see here both <code class="docutils literal notranslate"><span class="pre">many_char</span></code> and <code class="docutils literal notranslate"><span class="pre">many_char_0</span></code> being used:
<code class="docutils literal notranslate"><span class="pre">many_char</span></code> automatically flushes the cursor before and after which is not what we want when parsing a word. In fact, the only thing <code class="docutils literal notranslate"><span class="pre">many_char_0</span></code> does, is to move the cursor end until the given parser no longer matches the input.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ascii_alpha = char_pred(lambda c: 64 &lt; c &lt; 91 or 96 &lt; c &lt; 123)
ascii_num = char_pred(lambda c: 48 &lt;= c &lt; 58)
ascii_alpha_num = choice(ascii_alpha, ascii_num)
ascii_underscore = char(95)


def tokenize(p: Parser) -&gt; Parser:
    return sequence(p &gt;&gt; push, many_char(text_one_of(&quot; &quot;)), pop())

word = sequence(
    flush(), ascii_alpha, many_char_0(choice(ascii_alpha_num, ascii_underscore)),
    flush_decode())
</pre></div>
</div>
</div>
<p>The format line specifies the used data encoding: one of <code class="docutils literal notranslate"><span class="pre">ascii</span></code>, <code class="docutils literal notranslate"><span class="pre">binary_little_endian</span></code> or <code class="docutils literal notranslate"><span class="pre">binary_big_endian</span></code>, and a version number. The version number is always “1.0”.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ply_format = named_sequence(
    _1 = tokenize(text_literal(&quot;format&quot;)),
    format_str = tokenize(word),
    _2 = sequence(tokenize(text_literal(&quot;1.0&quot;)), eol)) \
&gt;&gt; construct(PlyFormat.from_string)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parse_bytes(ply_format, b&quot;format binary_little_endian 1.0\n&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;PlyFormat.BINARY_LE: 2&gt;
</pre></div></div>
</div>
<p>Comments may be placed in the header by using the word comment at the start of the line. Everything from there until the end of the line should then be ignored.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ply_comment = sequence(
    tokenize(text_literal(&quot;comment&quot;)), flush(),
    text_end_by(&quot;\n&quot;) &gt;&gt; push, optional(char(&quot;\r&quot;)), pop())
</pre></div>
</div>
</div>
<p>Now we need a parser for a data type, and given a data type we need to be able to parse that data either in ASCII or binary. There are two classes of types: primitive types and list types.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ply_type_table = {
    &quot;char&quot;: &quot;int8&quot;,
    &quot;uchar&quot;: &quot;uint8&quot;,
    &quot;short&quot;: &quot;int16&quot;,
    &quot;ushort&quot;: &quot;uint16&quot;,
    &quot;int&quot;: &quot;int32&quot;,
    &quot;uint&quot;: &quot;uint32&quot;,
    &quot;float&quot;: &quot;float32&quot;,
    &quot;double&quot;: &quot;float64&quot;
}

class PlyType:
    pass

@dataclass
class PlyPrimitiveType(PlyType):
    dtype: np.dtype

    @staticmethod
    def from_string(s: str) -&gt; PlyPrimitiveType:
        sanitized_name = ply_type_table.get(s, s)
        return PlyPrimitiveType(np.dtype(sanitized_name))

    @property
    def byte_size(self) -&gt; int:
        return self.dtype.itemsize

    def ascii(self) -&gt; Parser:
        return sequence(
            flush(), some_char_0(byte_none_of(b&quot;\n &quot;)),
            many_char_0(byte_one_of(b&quot;\n &quot;)), flush(self.dtype.type))

    def binary(self) -&gt; Parser:
        return binary_value(self.dtype)

@dataclass
class PlyListType(PlyType):
    size_type: PlyPrimitiveType
    value_type: PlyPrimitiveType

    def ascii(self) -&gt; Parser:
        return self.size_type.ascii() &gt;&gt; partial(repeat_n, self.value_type.ascii())

    def binary(self) -&gt; Parser:
        return binary_value(self.size_type.dtype) &gt;&gt; partial(array, self.value_type.dtype)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>primitive_type = tokenize(word) &gt;&gt; fmap(PlyPrimitiveType.from_string)

list_type = named_sequence(
    _1=tokenize(text_literal(&quot;list&quot;)),
    size_type=primitive_type,
    value_type=primitive_type) &gt;&gt; construct(PlyListType)

ply_type = choice(list_type, primitive_type)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parse_bytes(ply_type, b&quot;float float&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PlyPrimitiveType(dtype=dtype(&#39;float32&#39;))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp.pprint(parse_bytes(ply_type, b&quot;list uint8 float&quot;))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PlyListType(size_type=PlyPrimitiveType(dtype=dtype(&#39;uint8&#39;)),
            value_type=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)))
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@dataclass
class PlyProperty:
    dtype: PlyType
    name: str

ply_property = named_sequence(
    _1=tokenize(text_literal(&quot;property&quot;)),
    dtype=ply_type,
    name=tokenize(word),
    _2=eol) &gt;&gt; construct(PlyProperty)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parse_bytes(
    ply_property,
    b&quot;property float x\n&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)), name=&#39;x&#39;)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>end_header = sequence(text_literal(&quot;end_header&quot;), eol)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@dataclass
class PlyElement:
    name: str
    size: int
    properties: List[PlyProperty]

    def ascii(self) -&gt; Parser:
        single_item = named_sequence(
            **{p.name: p.dtype.ascii() for p in self.properties})
        return repeat_n(single_item, self.size)

    @property
    def afine(self) -&gt; bool:
        return all(isinstance(p.dtype, PlyPrimitiveType)
                   for p in self.properties)

    def binary(self) -&gt; Parser:
        if self.afine:
            compound_type = [(p.name, p.dtype.dtype) for p in self.properties]
            return array(compound_type, self.size)
        else:
            single_item = named_sequence(
                **{p.name: p.dtype.binary() for p in self.properties})
            return repeat_n(single_item, self.size)


ply_element = named_sequence(
    _1=tokenize(text_literal(&quot;element&quot;)),
    name=tokenize(word),
    size=tokenize(integer),
    _2=eol,
    properties=some(ply_property)) &gt;&gt; construct(PlyElement)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp.pprint(
    parse_bytes(
        some(ply_element),
        b&quot;element vertex 8\nproperty float x\nproperty float y\nproperty float z\n&quot; +
        b&quot;element face 6\nproperty list uchar int vertex_index\n&quot;))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ PlyElement(name=&#39;vertex&#39;,
             size=8,
             properties=[ PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                      name=&#39;x&#39;),
                          PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                      name=&#39;y&#39;),
                          PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                      name=&#39;z&#39;)]),
  PlyElement(name=&#39;face&#39;,
             size=6,
             properties=[ PlyProperty(dtype=PlyListType(size_type=PlyPrimitiveType(dtype=dtype(&#39;uint8&#39;)),
                                                        value_type=PlyPrimitiveType(dtype=dtype(&#39;int32&#39;))),
                                      name=&#39;vertex_index&#39;)])]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp.pprint(parse_bytes(ply_element, b&quot;element face 6\nproperty list uchar int vertex_index\n&quot;))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PlyElement(name=&#39;face&#39;,
           size=6,
           properties=[ PlyProperty(dtype=PlyListType(size_type=PlyPrimitiveType(dtype=dtype(&#39;uint8&#39;)),
                                                      value_type=PlyPrimitiveType(dtype=dtype(&#39;int32&#39;))),
                                    name=&#39;vertex_index&#39;)])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@dataclass
class PlyHeader:
    format: PlyFormat
    comment: List[str]
    elements: List[PlyElement]

    def parser(self) -&gt; Parser:
        if self.format == PlyFormat.ASCII:
            return named_sequence(
                **{e.name: e.ascii() for e in self.elements})
        if self.format == PlyFormat.BINARY_LE:
            return named_sequence(
                **{e.name: e.binary() for e in self.elements})
        else:
            raise NotImplementedError()

ply_header = named_sequence(
    _1=ply_magic_number,
    format=ply_format,
    comment=many(ply_comment),
    elements=some(ply_element),
    _2=sequence(text_literal(&quot;end_header&quot;), eol)) &gt;&gt; construct(PlyHeader)

def ply_data(header):
    return named_sequence(header=value(header), data=header.parser())

ply_file = ply_header &gt;&gt; ply_data
</pre></div>
</div>
</div>
<p>The following ASCII example is given on Paul Bourke’s page.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ascii_example = b&quot;&quot;&quot;ply
format ascii 1.0
comment made by Greg Turk
comment this file is a cube
element vertex 8
property float x
property float y
property float z
element face 6
property list uchar int vertex_index
end_header
0 0 0
0 0 1
0 1 1
0 1 0
1 0 0
1 0 1
1 1 1
1 1 0
4 0 1 2 3
4 7 6 5 4
4 0 4 5 1
4 1 5 6 2
4 2 6 7 3
4 3 7 4 0
&quot;&quot;&quot;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp.pprint(parse_bytes(ply_header, ascii_example))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PlyHeader(format=&lt;PlyFormat.ASCII: 1&gt;,
          comment=[&#39;made by Greg Turk&#39;, &#39;this file is a cube&#39;],
          elements=[ PlyElement(name=&#39;vertex&#39;,
                                size=8,
                                properties=[ PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                         name=&#39;x&#39;),
                                             PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                         name=&#39;y&#39;),
                                             PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                         name=&#39;z&#39;)]),
                     PlyElement(name=&#39;face&#39;,
                                size=6,
                                properties=[ PlyProperty(dtype=PlyListType(size_type=PlyPrimitiveType(dtype=dtype(&#39;uint8&#39;)),
                                                                           value_type=PlyPrimitiveType(dtype=dtype(&#39;int32&#39;))),
                                                         name=&#39;vertex_index&#39;)])])
</pre></div></div>
</div>
<p>No for the fun part! The header that we read actually encodes the parser for the rest of the file!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp.pprint(parse_bytes(ply_file, ascii_example))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{ &#39;data&#39;: { &#39;face&#39;: [ {&#39;vertex_index&#39;: [0, 1, 2, 3]},
                      {&#39;vertex_index&#39;: [7, 6, 5, 4]},
                      {&#39;vertex_index&#39;: [0, 4, 5, 1]},
                      {&#39;vertex_index&#39;: [1, 5, 6, 2]},
                      {&#39;vertex_index&#39;: [2, 6, 7, 3]},
                      {&#39;vertex_index&#39;: [3, 7, 4, 0]}],
            &#39;vertex&#39;: [ {&#39;x&#39;: 0.0, &#39;y&#39;: 0.0, &#39;z&#39;: 0.0},
                        {&#39;x&#39;: 0.0, &#39;y&#39;: 0.0, &#39;z&#39;: 1.0},
                        {&#39;x&#39;: 0.0, &#39;y&#39;: 1.0, &#39;z&#39;: 1.0},
                        {&#39;x&#39;: 0.0, &#39;y&#39;: 1.0, &#39;z&#39;: 0.0},
                        {&#39;x&#39;: 1.0, &#39;y&#39;: 0.0, &#39;z&#39;: 0.0},
                        {&#39;x&#39;: 1.0, &#39;y&#39;: 0.0, &#39;z&#39;: 1.0},
                        {&#39;x&#39;: 1.0, &#39;y&#39;: 1.0, &#39;z&#39;: 1.0},
                        {&#39;x&#39;: 1.0, &#39;y&#39;: 1.0, &#39;z&#39;: 0.0}]},
  &#39;header&#39;: PlyHeader(format=&lt;PlyFormat.ASCII: 1&gt;,
                      comment=[&#39;made by Greg Turk&#39;, &#39;this file is a cube&#39;],
                      elements=[ PlyElement(name=&#39;vertex&#39;,
                                            size=8,
                                            properties=[ PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                                     name=&#39;x&#39;),
                                                         PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                                     name=&#39;y&#39;),
                                                         PlyProperty(dtype=PlyPrimitiveType(dtype=dtype(&#39;float32&#39;)),
                                                                     name=&#39;z&#39;)]),
                                 PlyElement(name=&#39;face&#39;,
                                            size=6,
                                            properties=[ PlyProperty(dtype=PlyListType(size_type=PlyPrimitiveType(dtype=dtype(&#39;uint8&#39;)),
                                                                                       value_type=PlyPrimitiveType(dtype=dtype(&#39;int32&#39;))),
                                                                     name=&#39;vertex_index&#39;)])])}
</pre></div></div>
</div>
</section>
<section id="The-Stanford-Bunny">
<h2>The Stanford Bunny<a class="headerlink" href="#The-Stanford-Bunny" title="Permalink to this heading"></a></h2>
<p>Now that we have the capability to parse binary PLY files, we can load the Stanford Bunny. For visualisation purposes it helps to know that all faces in this file are triangles.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from pathlib import Path

bunny = parse_bytes(ply_file, Path(&quot;_static/stanford_bunny.ply&quot;).open(mode=&quot;rb&quot;).read())
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>vertices = bunny[&quot;data&quot;][&quot;vertex&quot;].view((np.float32, 3))
triangles = np.array([row[&quot;vertex_indices&quot;] for row in bunny[&quot;data&quot;][&quot;face&quot;]])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from mpl_toolkits import mplot3d
from matplotlib import pyplot as plt
# For interactive use: install ipympl and run:
# %matplotlib widget
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig = plt.figure(figsize=(12,12))
ax = plt.axes(projection=&quot;3d&quot;)
ax.azim = -18
ax.elev = 15
ax.plot_trisurf(*vertices.T[[2,0,1]], triangles=triangles);
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ply_34_0.png" src="_images/ply_34_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ppm.html" class="btn btn-neutral float-left" title="Parsing PPM files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="architecture.html" class="btn btn-neutral float-right" title="Architecture" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Netherlands eScience Center, University of Groningen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>