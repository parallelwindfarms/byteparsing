<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction to Functional Parsing in Python &mdash; byteparsing 0.1.2 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples of usage" href="examples.html" />
    <link rel="prev" title="Parsers" href="parsers.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> byteparsing
          </a>
              <div class="version">
                0.1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cursors.html">Cursors</a></li>
<li class="toctree-l1"><a class="reference internal" href="parsers.html">Parsers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction to Functional Parsing in Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#First-parsers">First parsers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Failures">Failures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Many-and-some">Many and some</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Choices">Choices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Nested-structures">Nested structures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Sequencing">Sequencing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Trampolines">Trampolines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-full-parser">The full parser</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Cursor">Cursor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Auxiliary-state">Auxiliary state</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Hide-trace-backs">Hide trace backs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples of usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="ppm.html">Parsing PPM files</a></li>
<li class="toctree-l1"><a class="reference internal" href="ply.html">Advanced example: parsing PLY files</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">byteparsing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Introduction to Functional Parsing in Python</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/functional.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Introduction-to-Functional-Parsing-in-Python">
<h1>Introduction to Functional Parsing in Python<a class="headerlink" href="#Introduction-to-Functional-Parsing-in-Python" title="Permalink to this heading"></a></h1>
<p>First of all, I should tell you why parsers are so beautifully expressed in a functional framework: a lot of grammars have an inherently recursive structure. Take as an example a structure of nested lists:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">a</span><span class="p">,[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">d</span><span class="p">,[[</span><span class="n">e</span><span class="p">]]]</span>
</pre></div>
</div>
<p>From such an example we can expect to see recursion playing a role in parsing. In BNF this looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;expr&gt;   ::<span class="o">=</span> &lt;list&gt; <span class="p">|</span> &lt;symbol&gt;
&lt;list&gt;   ::<span class="o">=</span> <span class="s1">&#39;[&#39;</span> &lt;seq&gt; <span class="s1">&#39;]&#39;</span>
&lt;seq&gt;    ::<span class="o">=</span> &lt;expr&gt; <span class="p">|</span> &lt;expr&gt; <span class="s1">&#39;,&#39;</span> &lt;seq&gt;
&lt;symbol&gt; ::<span class="o">=</span> <span class="s1">&#39;a-z&#39;</span> <span class="p">|</span> &lt;symbol&gt;
</pre></div>
</div>
<p>Note: if you find this notation confusing, you may want to take a look at <a class="reference external" href="https://www.youtube.com/watch?v=dDtZLm7HIJs">this video</a>.</p>
<p>Notice the definition of a <code class="docutils literal notranslate"><span class="pre">&lt;list&gt;</span></code> depends on <code class="docutils literal notranslate"><span class="pre">&lt;seq&gt;</span></code> depends on <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code> depends on <code class="docutils literal notranslate"><span class="pre">&lt;list&gt;</span></code>. Seen like this, even <code class="docutils literal notranslate"><span class="pre">&lt;seq&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code> are recursive in the BNF; although in this case the (simple) recursion expresses the sequential nature of these grammars. In the case of sequences, we may replace the recursion with an (imperative) for-loop and be done with it. In almost every real word case however, we deal with more involved recursions like the nested list example. Functional
parsers often have definitions that lie closer to the BNF notation shown above. Functional languages in which these parsers are implemented often have the features (either tail-call elimination or lazy evaluation) to handle these definitions without too much loss of performance.</p>
<blockquote>
<div><p class="rubric" id="tail-recursion-in-bnf">Tail recursion in BNF</p>
<p>Let’s expand the definition of <code class="docutils literal notranslate"><span class="pre">&lt;list&gt;</span></code> by replacing <code class="docutils literal notranslate"><span class="pre">&lt;seq&gt;</span></code> with its definition (We’ll use parentheses and ellipses in free but predictable manner).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;list&gt; <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">(</span>&lt;expr&gt; <span class="p">|</span> &lt;expr&gt; <span class="s1">&#39;,&#39;</span> &lt;seq&gt;<span class="o">)</span> <span class="s1">&#39;]&#39;</span>
&lt;list&gt; <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">((</span>&lt;list&gt; <span class="p">|</span> &lt;symbol&gt;<span class="o">)</span> <span class="p">|</span> <span class="o">(</span>&lt;list&gt; <span class="p">|</span> &lt;symbol&gt;<span class="o">)</span> <span class="s1">&#39;,&#39;</span> &lt;seq&gt;<span class="o">)</span> <span class="s1">&#39;]&#39;</span>
</pre></div>
</div>
<p>We may now choose a path in this expression. A possible <code class="docutils literal notranslate"><span class="pre">&lt;list&gt;</span></code> looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;list&gt; <span class="o">=</span>? <span class="s1">&#39;[&#39;</span> &lt;list&gt; <span class="s1">&#39;,&#39;</span> &lt;seq&gt; <span class="s1">&#39;]&#39;</span>
</pre></div>
</div>
<p>We see <code class="docutils literal notranslate"><span class="pre">&lt;list&gt;</span></code> reappearing in a position that is not at the tail-end of the BNF expression. Contrast this to <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;symbol&gt; <span class="o">=</span> <span class="s1">&#39;a-z&#39;</span> <span class="s1">&#39;a-z&#39;</span> ... <span class="o">(</span><span class="s1">&#39;a-z&#39;</span> <span class="p">|</span> &lt;symbol&gt;<span class="o">)</span>
</pre></div>
</div>
<p>No matter how we expand the expression, the recursion is always at the end. In evaluating a tail-recursion, the recursion can always be converted to a (more efficient) loop.</p>
</div></blockquote>
<p>Because Python is neither lazy nor tail-recursive, we need to do a bit more work. We use a <strong>trampoline</strong> to effect tail recursion.</p>
<p>Functional parsers (or parser-combinators) are a method of writing and combining parsers. They allow you to build complex parsers from the ground up using a set of basic primitives. The structure is outlined in the beautiful Functional Pearl by Hutton and Meijer [&#64;monadic-parsing].</p>
<p>Since monads are not really a thing in Python, we’ll have to somehow translate these concepts. In its most basic form, a parser is a function that takes a string and returns a parsed object together with the rest of the string. Graham Hutton puts it in a rhyme, which I changed slightly to suit our context:</p>
<blockquote>
<div><div class="line-block">
<div class="line">A parser for things</div>
<div class="line">Is a function from strings</div>
<div class="line">To options of pairs</div>
<div class="line">Of things and strings</div>
</div>
</div></blockquote>
<p>The optional part in our case means: may throw an exception instead.</p>
<section id="First-parsers">
<h2>First parsers<a class="headerlink" href="#First-parsers" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from typing import Optional, Union, Callable, Any, TypeVar, Generic

T = TypeVar(&quot;T&quot;)
Parser = Callable[[str], tuple[T, str]]
</pre></div>
</div>
</div>
<section id="Failures">
<h3>Failures<a class="headerlink" href="#Failures" title="Permalink to this heading"></a></h3>
<p>If the parser fails, a <code class="docutils literal notranslate"><span class="pre">Failure</span></code> is raised.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from dataclasses import dataclass

class Failure(Exception):
    def __init__(self, msg: str):
        self.msg = msg

    def __str__(self):
        return self.msg


class EndOfInput(Failure):
    def __init__(self):
        super().__init__(&quot;End of input.&quot;)


class Expected(Failure):
    def __init__(self, inp: str, msg: str):
        self.msg = msg
        self.inp = inp

    def __str__(self):
        return f&quot;{self.msg}, got: {self.inp}&quot;
</pre></div>
</div>
</div>
<p>We start with an example of a function that parses a positive integer. Here we use a regular expression to parse the integer itself. From this first parser we’ll expand out to write something that can parse an arbitrarily nested list of integers.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import re

def integer(inp: str) -&gt; tuple[int, str]:
    if m := re.match(&quot;[0-9]+&quot;, inp):
        result = int(m[0])
        rest = inp[m.end(0):]
        return (result, rest)
    else:
        raise Expected(inp, &quot;a number&quot;)
</pre></div>
</div>
</div>
<p>Let’s test this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>integer(&quot;42&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(42, &#39;&#39;)
</pre></div></div>
</div>
<p>Note that the second return value is the part of the input that is remaining after our parser is done.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>integer(&quot;89, 20, 40&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(89, &#39;, 20, 40&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>integer(&quot;hello&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Expected: a number, got: hello
</pre></div></div>
</div>
<p>Now say we want to parse <strong>two</strong> integers. We need to be able to parse some whitespace.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def whitespace(inp: str) -&gt; tuple[str, str]:
    m = re.match(&quot;\s+&quot;, inp)
    if not m:
        raise Expected(inp, &quot;whitespace&quot;)
    return (m[0], inp[m.end(0):])
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>whitespace(&quot;    abcd&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;    &#39;, &#39;abcd&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>whitespace(&quot;abcd&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Expected: whitespace, got: abcd
</pre></div></div>
</div>
<p>In many cases whitespace is optional. We can write another parser that catches the exception for us.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def optional(p: Parser[T]) -&gt; Parser[Optional[T]]:
    def optional_p(inp: str) -&gt; tuple[Optional[T], str]:
        try:
            (x, inp) = p(inp)
        except Failure:
            return (None, inp)
        return (x, inp)
    return optional_p
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>optional(whitespace)(&quot;abcd&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(None, &#39;abcd&#39;)
</pre></div></div>
</div>
<p>Let us try to parse a pair of integers now.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def twice(p: Parser[T]) -&gt; Parser[tuple[T, T]]:
    def twiced(inp: str) -&gt; tuple[tuple[T, T], str]:
        (a, inp) = p(inp)
        (_, inp) = whitespace(inp)
        (b, inp) = p(inp)
        return ((a, b), inp)
    return twiced
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>twice(integer)(&quot;1 2 3 4&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((1, 2), &#39; 3 4&#39;)
</pre></div></div>
</div>
<p>We could also go for a comma separated list of integers. First we need to parse a comma.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def char(allowed: str) -&gt; Parser[str]:
    def char_p(inp: str) -&gt; tuple[str, str]:
        if not inp or inp[0] not in allowed:
            raise Expected(inp, f&quot;one of \&quot;{allowed}\&quot;&quot;)
        return (inp[0], inp[1:])
    return char_p
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>char(&quot;abc&quot;)(&quot;abbcaabd&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;a&#39;, &#39;bbcaabd&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>char(&quot;abc&quot;)(&quot;d&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Expected: one of &#34;abc&#34;, got: d
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>comma = char(&quot;,&quot;)
comma(&quot;, 20, 40&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;,&#39;, &#39; 20, 40&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>comma(&quot;89, 20, 40&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Expected: one of &#34;,&#34;, got: 89, 20, 40
</pre></div></div>
</div>
<p>It will be convenient to have a function that parses a thing and then also consumes the whitespace after it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def tokenize(p: Parser[T]) -&gt; Parser[T]:
    def tokenized(inp: str) -&gt; tuple[T, str]:
        (x, inp) = p(inp)
        (_, inp) = optional(whitespace)(inp)
        return (x, inp)
    return tokenized
</pre></div>
</div>
</div>
<p>Notice that the definition of <code class="docutils literal notranslate"><span class="pre">tokenize</span></code> no longer contains any raw string processing! Also, see how the whitespace is stripped from our input!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>comma = tokenize(char(&quot;,&quot;))
comma(&quot;,     ######&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;,&#39;, &#39;######&#39;)
</pre></div></div>
</div>
<p>We now want to parse a list of integers, separated by commas. We can try to do this recursively.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>U = TypeVar(&quot;U&quot;)

def sep_by(p: Parser[T], sep: Parser[U]) -&gt; Parser[list[T]]:
    def sep_byed(inp: str) -&gt; tuple[list[T], str]:
        # parse an integer
        (x, inp) = p(inp)
        try:
            # parse a comma
            (_, _inp) = sep(inp)
            # parse the rest of the list
            (rest, inp) = sep_byed(_inp)
        except Failure:
            return ([x], inp)
        return ([x] + rest, inp)
    return sep_byed
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sep_by(integer, comma)(&quot;1, 2, 3, 4, abcde&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([1, 2, 3, 4], &#39;, abcde&#39;)
</pre></div></div>
</div>
<p>This implementation is not so effecient, and because it uses recursion we run the risc of stack overflow. We can write the inner function in an imperative style to be more efficient here. Later on we will see that we can write recursive parsers safely, but even then, seeing that this is Python and not Haskell, it can be advantageous to rewrite some core parsers imperitavely. The important bit is that the framework still stands: the outer world doesn’t see your trash.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def sep_by(p: Parser[T], sep: Parser[U]) -&gt; Parser[list[T]]:
    def sep_byed(inp: str) -&gt; tuple[list[T], str]:
        result = []
        inp_bc = inp
        while True:
            try:
                (x, inp_bc) = p(inp)
                result.append(x)
                (_, inp) = sep(inp_bc)
            except Failure:
                return (result, inp_bc)
    return sep_byed
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sep_by(integer, comma)(&quot;1, 2, 3, 4, abcde&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([1, 2, 3, 4], &#39;, abcde&#39;)
</pre></div></div>
</div>
</section>
<section id="Many-and-some">
<h3>Many and some<a class="headerlink" href="#Many-and-some" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">many</span></code> and <code class="docutils literal notranslate"><span class="pre">some</span></code> are bread and butter of parser combinators. An important fact to note here is that <code class="docutils literal notranslate"><span class="pre">many</span></code> will always succeed. Having nested <code class="docutils literal notranslate"><span class="pre">many</span></code> parsers may result in infinite loops.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def many(p: Parser[T]) -&gt; Parser[list[T]]:
    def manied(inp: str) -&gt; tuple[list[T], str]:
        result = []
        while True:
            try:
                (x, inp) = p(inp)
                result.append(x)
            except Failure:
                return (result, inp)
    return manied
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def some(p: Parser[T]) -&gt; Parser[list[T]]:
    def somed(inp: str) -&gt; tuple[list[T], str]:
        (x, inp) = p(inp)
        (rest, inp) = many(p)(inp)
        return ([x] + rest, inp)
    return somed
</pre></div>
</div>
</div>
<p>As an example, we can now write a parser for a list of integers, S-expression style.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def list_of(p: Parser[T]) -&gt; Parser[list[T]]:
    def listed(inp: str) -&gt; tuple[list[T], str]:
        (_, inp) = tokenize(char(&quot;(&quot;))(inp)
        (x, inp) = many(p)(inp)
        (_, inp) = tokenize(char(&quot;)&quot;))(inp)
        return (x, inp)
    return listed
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>list_of(tokenize(integer))(&quot;(1 2 3)&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([1, 2, 3], &#39;&#39;)
</pre></div></div>
</div>
</section>
<section id="Choices">
<h3>Choices<a class="headerlink" href="#Choices" title="Permalink to this heading"></a></h3>
<p>Another common pattern is when we have several options to parse. For the <code class="docutils literal notranslate"><span class="pre">choice</span></code> parser we need a new type of <code class="docutils literal notranslate"><span class="pre">Failure</span></code>, namely one that outlines the different expectations and why they all failed. The <code class="docutils literal notranslate"><span class="pre">choice</span></code> parser tries each parser in the order they were given; the first parser to succeed gets the go-ahead.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class ChoiceFailure(Expected):
    def __init__(self, inp, failures):
        super().__init__(inp, &quot;&quot;)
        self.failures = failures

    def __str__(self):
        return &quot;All options failed:\n&quot; + &quot;\n&quot;.join(
            &quot;    | &quot; + f.msg for f in self.failures) + \
            f&quot;\ngot: {self.inp}&quot;

def choice(*ps: Parser[T]) -&gt; Parser[T]:
    def choiced(inp: str) -&gt; tuple[T, str]:
        failures = []
        for p in ps:
            try:
                (x, inp) = p(inp)
            except Failure as f:
                failures.append(f)
                continue
            else:
                return (x, inp)
        raise ChoiceFailure(inp, failures)
    return choiced
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>many(choice(char(&quot;abc&quot;), char(&quot;123&quot;)))(&quot;12ab3#$*&amp;(*&amp;@&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([&#39;1&#39;, &#39;2&#39;, &#39;a&#39;, &#39;b&#39;, &#39;3&#39;], &#39;#$*&amp;(*&amp;@&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>some(choice(char(&quot;abc&quot;), char(&quot;123&quot;), whitespace))(&quot;#&amp;*(&amp;@&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
ChoiceFailure: All options failed:
    | one of &#34;abc&#34;
    | one of &#34;123&#34;
    | whitespace
got: #&amp;*(&amp;@
</pre></div></div>
</div>
</section>
<section id="Nested-structures">
<h3>Nested structures<a class="headerlink" href="#Nested-structures" title="Permalink to this heading"></a></h3>
<p>We are now ready to parse a nested list structure. Note that the only reason why we put this parser in a function explicitely is to allow the recursion.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def nested_list(p: Parser[T]) -&gt; Parser[Any]:
    def nested_listed(inp: str) -&gt; tuple[Any, str]:
        return choice(p, list_of(nested_list(p)))(inp)
    return nested_listed
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nested_list(tokenize(integer))(&quot;(1 2 (3 4  )5 (() (6)))&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
([1, 2, [3, 4], 5, [[], [6]]], &#39;&#39;)
</pre></div></div>
</div>
<p>This concludes the basic introduction to parser combinators. What is left is finding ways of writing down parsers in a nicer way. First we’ll have to deal with the pesky problem of recursion.</p>
</section>
</section>
<section id="Sequencing">
<h2>Sequencing<a class="headerlink" href="#Sequencing" title="Permalink to this heading"></a></h2>
<p>We have seen several instances where we had to sequence <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">inp)</span> <span class="pre">=</span> <span class="pre">parse(inp)</span></code>. It would be nice if we could combine parsers in a smarter way, and have them plug together. In other words: we can make these parsers more composable. Suppose we want a function <code class="docutils literal notranslate"><span class="pre">sequence(*ps)</span></code> that parses each argument in order, and returns the result of the last parser. An imperative solution looks as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def sequence(*ps: Parser[Any]) -&gt; Parser[Any]:
    def sequenced(inp: str) -&gt; tuple[Any, str]:
        for p in ps:
            (x, inp) = p(inp)
        return (x, inp)
    return sequenced
</pre></div>
</div>
</div>
<p>Every intermediate result is thrown away. Now suppose we have two parsers, we need the result of the first one, but only if the second one succeeds. We saw this case before when we were parsing lists. We make things a bit easier by omitting commas, so we’re parsing <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">2</span> <span class="pre">3)</span></code> now.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def list_of(p: Parser[T]) -&gt; Parser[list[T]]:
    return sequence(char(&quot;(&quot;), closed_by(many(p), char(&quot;)&quot;)))
</pre></div>
</div>
</div>
<p>How would we implement <code class="docutils literal notranslate"><span class="pre">closed_by()</span></code>?</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def closed_by(p1: Parser[T], p2: Parser[U]) -&gt; Parser[T]:
    def closed_byed(inp: str) -&gt; tuple[T, str]:
        (x, inp) = p1(inp)
        (_, inp) = p2(inp)
        return (x, inp)
    return closed_byed
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def value(x: T) -&gt; Parser[T]:
    def valued(inp: str) -&gt; tuple[T, str]:
        return (x, inp)
    return valued

def closed_by(p1: Parser[T], p2: Parser[U]) -&gt; Parser[T]:
    # return bind(p1, lambda x: bind(p2, lambda _: value(x)))
    return p1 &gt;&gt; (lambda x: p2 &gt;&gt; (lambda _: value(x)))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def sequence_recur(p: Parser[Any], *ps: Parser[Any]) -&gt; Parser[Any]:
    def sequenced(inp: str) -&gt; tuple[Any, str]:
        (_, inp) = p(inp)
        return sequence_recur(*ps)(inp)

    if ps:
        return sequenced
    else:
        return p


def bind(p: Parser[T], f: Callable[(T,), Parser[U]]) -&gt; Parser[U]:
    def bound(inp: str) -&gt; tuple[U, str]
        (x, inp) = p(inp)
        return f(x)(inp)
    return bound


def sequence_bind(p: Parser[Any], *ps: Parser[Any]) -&gt; Parser[Any]:
    if ps:
        return bind(p, lambda _: sequence_bind(*ps))
    else
        return p
</pre></div>
</div>
</div>
</section>
<section id="Trampolines">
<h2>Trampolines<a class="headerlink" href="#Trampolines" title="Permalink to this heading"></a></h2>
<p>Trampolines can be a bit tricky to understand, so we first explain them using the example of a <code class="docutils literal notranslate"><span class="pre">factorial</span></code> function. The factorial of <span class="math notranslate nohighlight">\(n\)</span>, noted <span class="math notranslate nohighlight">\(n! := n (n - 1)!\)</span>, also <span class="math notranslate nohighlight">\(0! := 1\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def factorial(n):
    if n == 0:
        return 1
    else:
        return n * factorial(n - 1)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>factorial(10)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3628800
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>factorial(10000)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
RecursionError: maximum recursion depth exceeded in comparison
</pre></div></div>
</div>
<p>How can we elude this recursion? We could write a for-loop, but let’s say we want still want to use write a recursion. After all, when we’re writing parsers recursions can become inevitable: see for instance the nested list example. First what we need to change is to make the function <strong>tail-recursive</strong>. This is done by adding an accumulator argument.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def factorial(n, acc=1):
    if n == 0:
        return acc
    else:
        return factorial(n-1, acc*n)
</pre></div>
</div>
</div>
<p>The difference is that we return the direct result of the recursive function call. In the previous version we still had to multiply the result of the recursion by <code class="docutils literal notranslate"><span class="pre">n</span></code>. If the return value of a function is the direct result of another (recursive) function call, we may call the function <strong>tail-recursive</strong>. Written in this way, we can prevent the call from allocating another stack frame.</p>
<p>What we do is <strong>delaying the call</strong>.</p>
<p>We store the function call in an object of class <code class="docutils literal notranslate"><span class="pre">Trampoline</span></code>. We may call the <code class="docutils literal notranslate"><span class="pre">compute()</span></code> method on this class to start a loop. This loop keeps evaluating successive calls, until the result is something else than a <code class="docutils literal notranslate"><span class="pre">Trampoline</span></code> object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class Trampoline:
    def __init__(self, func, *args, **kwargs):
        self.func = func
        self.args = args
        self.kwargs = kwargs

    def compute(self):
        cont = self
        while True:
            cont = cont.func(*cont.args, **cont.kwargs)
            if not isinstance(cont, Trampoline):
                return cont

def factorial(n, acc=1):
    if n == 0:
        return acc
    else:
        return Trampoline(factorial, n-1, acc*n)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from math import log10
log10(factorial(10000).compute())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
35659.45427452078
</pre></div></div>
</div>
<p>We can make this example a bit more beautiful by providing a decorator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from functools import (wraps, partial)

def trampoline(f):
    return wraps(f)(partial(Trampoline, f))
</pre></div>
</div>
</div>
<p>Now we can keep our old definition!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@trampoline
def factorial(n, acc=1):
    if n == 0:
        return acc
    else:
        return factorial(n-1, acc*n)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>log10(factorial(10000).compute())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
35659.45427452078
</pre></div></div>
</div>
</section>
<section id="The-full-parser">
<h2>The full parser<a class="headerlink" href="#The-full-parser" title="Permalink to this heading"></a></h2>
<p>These parsers had us chain several <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">inp)</span> <span class="pre">=</span> <span class="pre">some_parser(inp)</span></code> together. It would be cool if we had a better syntax to write that. To do this however, we need to wrap our parser functions in a class. Then the question is also: how do we propagate the return value <code class="docutils literal notranslate"><span class="pre">x</span></code> through this chain? In Haskell this problem is solved with monads. We can try to do the same in Python, especially now that we have trampolines.</p>
<p>There will be two more additions to the scheme outlined above: the <strong>cursor</strong> and the <strong>auxiliary state</strong> object.</p>
<section id="Cursor">
<h3>Cursor<a class="headerlink" href="#Cursor" title="Permalink to this heading"></a></h3>
<p>When parsing larger files it can be inefficient to parse a text character by character. Often, we need to pass a certain amount of text to a secondary function that then converts the string into a value for us. Instead of working directly with strings we can use a <code class="docutils literal notranslate"><span class="pre">Cursor</span></code> class.</p>
<p>In normal parsing mode, we need only to know the position of the cursor within the text; however, on many occasion it is useful to have a cursor object that spans a selection of text being parsed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@dataclass
class Cursor:
    data: bytes
    begin: int
    end: int
    encoding: str = &quot;utf-8&quot;

    def __len__(self):
        &quot;&quot;&quot;Length of selection.&quot;&quot;&quot;
        return self.end - self.begin

    def __bool__(self):
        &quot;&quot;&quot;Returns `True` if there is more input to parse, `False` otherwise.&quot;&quot;&quot;
        return self.end &lt; len(self.data)

    ...
</pre></div>
</div>
</div>
<p>For the full definition, see the corresponding API documentation.</p>
</section>
<section id="Auxiliary-state">
<h3>Auxiliary state<a class="headerlink" href="#Auxiliary-state" title="Permalink to this heading"></a></h3>
<p>The same way we pass the cursor state through all the parser calls, we can track auxiliary state. The complete function signature of a parser then looks like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def some_parser(cursor: Cursor, aux: Any) -&gt; tuple[T, Cursor, Any]:
    pass
</pre></div>
</div>
</div>
<p>In the current set of parsers, this state is used as a stack. The stack is initialized with the empty list, then values can be pushed and popped using the <code class="docutils literal notranslate"><span class="pre">push</span></code> and <code class="docutils literal notranslate"><span class="pre">pop</span></code> parsers. The <code class="docutils literal notranslate"><span class="pre">pop</span></code> parser takes an optional <code class="docutils literal notranslate"><span class="pre">transfer</span></code> argument that maps the content of the popped value.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from byteparsing import sequence, push, pop

sequence(push(42), pop()).parse(b&quot;&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
42
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from byteparsing import many_char_0, flush_decode, char, ascii_alpha, flush

sequence(char(&quot;(&quot;), flush(),
         many_char_0(ascii_alpha),
         flush_decode() &gt;&gt; push,
         char(&quot;)&quot;),
         pop(str.upper)).parse(b&quot;(hello)&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;HELLO&#39;
</pre></div></div>
</div>
</section>
</section>
<section id="Hide-trace-backs">
<h2>Hide trace backs<a class="headerlink" href="#Hide-trace-backs" title="Permalink to this heading"></a></h2>
<p>For the purpose of this notebook it was better to hide tracebacks on exceptions. Run this cell first, then the rest.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import sys
ipython = get_ipython()

def exception_handler(exception_type, exception, traceback):
    print(&quot;%s: %s&quot; % (exception_type.__name__, exception), file=sys.stderr)

ipython._showtraceback = exception_handler
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parsers.html" class="btn btn-neutral float-left" title="Parsers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="examples.html" class="btn btn-neutral float-right" title="Examples of usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Netherlands eScience Center, University of Groningen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>